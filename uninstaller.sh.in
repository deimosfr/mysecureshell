#!/bin/sh

## Uninstaller Script v0.3 for MySecureShell made by Pierre
## Updated by Igor P. Zenkov May 2, 2019
## MySecureShell Team <teka2nerdman@users.sourceforge.net>

## Language local initialising

BINDIR=@BINDIR@
MANDIR=@MANDIR@
USRBINDIR=@BINDIR@
ETCDIR=@ETCDIR@
MSS_LOG=@MSS_LOG@

LANG=

BINFILES='mysecureshell sftp-who sftp-state sftp-kill sftp-admin sftp-user sftp-verif'
MANFILES='MySecureShell.8 mysecureshell.8 sftp-admin.8 sftp-kill.8 sftp-state.8 sftp-user.8 sftp-verif.8 sftp-who.8'
CFGFILES='ssh/sftp_config sshd/sftp_config'

## Functions Looking for available languages

MyGetLocale()
{
	if [ "$LANG" = "" ] ; then
		echo $1
	else
		tmp=`grep -F "$1=" locales_$LANG | cut -d= -f2-`
		if [ "$tmp" = "" ] ; then
			echo $1
		else
			echo $tmp
		fi
	fi
}

MyListLocale()
{
	echo "The available languages are:"
	grep -F 'DESCRIPTION=' locales_* | cut -d= -f2-
	echo "Usage: ./uninstaller.sh xx(language)"
}

MyRmFiles()
{
	# $1: dir $2: files
	for f in $2; do
		rm -f "$1/$f"
	done
}

MyRmMans()
{
	# $1: man dir
	if [ -d "$1" ] ; then
		MyRmFiles "$1" "$MANFILES"
		rmdir -p "$1" &> /dev/null
	fi
}

## Main

if [ "$1" = "" ] ; then
	MyListLocale
	exit 1
else
	if [ -f "locales_$1" ] ; then
		LANG=$1
	fi
fi

clear

## Root detection
euid="`id -u`"
if [ "$euid" != "0" ] ; then
	echo ""
	echo "###################################################################"
	tmp=`MyGetLocale 'sorry'`
	echo "	               $tmp"
	MyGetLocale 'Warning root ask'
	echo "###################################################################"
	echo ""
	exit 1
fi

MyGetLocale 'uninst?'
read ans
test -z "$ans" && ans="n"
case "$ans" in
	[yY])
		MyRmFiles "$BINDIR" "$BINFILES"
		cat /etc/shells | grep -v MySecureShell > /tmp/shells~
		mv /tmp/shells~ /etc/shells

	# Only for Mac OS X
		if [ -d /Applications/MySecureShell ] ; then
			rm -Rf /Applications/MySecureShell
		else
			break
		fi
		if [ -d /Library/Receipts ] ; then
			rm -Rf /Library/Receipts/MySecureShell*
		else
			break
		fi

	# Delete mans
		MyRmMans "$MANDIR/man8"
		MyRmMans "$MANDIR/en/man8" 
		MyRmMans "$MANDIR/fr/man8"

	# Delete configuration ?
		MyGetLocale 'delconf?'
		read ans2
		test -z "$ans2" && ans2="n"
		case "$ans2" in
			[yY])
				MyRmFiles "$ETCDIR" "$CFGFILES"
				;;
		esac

	# Delete log ?
		MyGetLocale 'dellog?'
		read ans3
		test -z "$ans3" && ans3="n"
		case "$ans3" in
			[yY])
				rm -f "$MSS_LOG"
				;;
		esac

		MyGetLocale 'mssuninstok!'
		;;
	*)
		MyGetLocale 'mssuninstfail'
		;;
esac
